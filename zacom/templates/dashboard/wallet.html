{% extends 'user_templates/base.html' %}

{% block content %}
{% load static %}

<!-- Bootstrap core CSS -->
<link href="{% static 'user_static/assets/css/bootstrap.min.css' %}" rel="stylesheet">

<!-- Paper Dashboard core CSS -->
<link href="{% static 'user_static/assets/css/paper-dashboard.css' %}" rel="stylesheet"/>

<!-- CSS for Demo Purpose, don't include it in your project -->
<link href="{% static 'user_static/assets/css/demo.css' %}" rel="stylesheet" />

<!-- Fonts and icons -->
<link href="http://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
<link href="{% static 'user_static/assets/css/themify-icons.css' %}" rel="stylesheet">

<div class="container-fluid">
    <div class="row">
        <div class="col-md-11 mx-auto mt-5">
            <div class="nav column gap-4 p-3 small bg-danger rounded-5 shadow-sm" role="tablist">
                <li class="nav-item">
                    <a class="nav-link rounded-5" href="{% url 'profile' %}">Profile</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link rounded-5" href="{% url 'address-detail' %}">Address</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link rounded-5" href="{% url 'order' %}">Orders</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active rounded-5" href="{% url 'wallet' %}">Wallet</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link rounded-5" href="{% url 'coupon-detail' %}">Coupon</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link rounded-5" href="{% url 'referral-detail' %}">Referral</a>
                </li>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-10 mx-auto mt-5">
            <div class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card card-user">
                                <div class="image">
                                    <img src="{% static 'user_static/assets/img/background.jpg' %}" alt="Background"/>
                                </div>
                                <div class="content">
                                    <div class="author">
                                        <img class="avatar border-white" src="{% static 'user_static/img/user-profile.jpg' %}" alt="User Profile"/>
                                        <h4 class="title">{{ user_detail.first_name }} {{ user_detail.last_name }}<br />
                                            <small>@{{ user_detail.username }}</small>
                                        </h4>
                                    </div>
                                    <p class="description text-center">
                                        {{ user_detail.email }} <br>
                                        {{ user_detail.phone_number }} <br>
                                    </p>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <h5>{{ order_dtails.count }}<br /><small>Orders</small></h5>
                                        </div>
                                        <div class="col-md-4">
                                            <h5>2GB<br /><small>Wallet</small></h5>
                                        </div>
                                        <div class="col-md-4">
                                            <h5>24,6$<br /><small>Spent</small></h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="container-fluid">
                                <div class="d-sm-flex justify-content-between align-items-center bg-light rounded p-3 my-3">
                                    <div class="d-flex align-items-center mb-3 mb-sm-0">
                                        <i class="fa-solid fa-wallet text-primary" style="font-size: 40px;"></i>
                                        <span class="ms-3 fw-bold">Wallet Balance: {{ wallet.balance }}</span>
                                    </div>
                                    <button id="addMoneyBtn" class="btn btn-primary btn-lg">Add Money</button>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        {% if transactions %}
                                        <thead>
                                            <tr>
                                                <th>No</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for i in transactions %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                {% if i.transaction_type == 'CREDIT' %}
                                                <td style="color: darkgreen;">+{{ i.amount }}</td>
                                                {% else %}
                                                <td style="color: #ca1515;">-{{ i.amount }}</td>
                                                {% endif %}
                                                <td>{{ i.created_at }}</td>
                                            </tr>
                                            {% endfor %}
                                            {% else %}
                                            <tbody>
                                                <tr>
                                                    <td colspan="3" class="text-center">No transaction found. Add money to your wallet now</td>
                                                </tr>
                                            </tbody>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    document.getElementById('addMoneyBtn').addEventListener('click', () => {
        Swal.fire({
            title: "Enter the amount",
            input: "text",
            inputAttributes: {
                autocapitalize: "off",

            },
            showCancelButton: true,
            confirmButtonText: "Submit",
            showLoaderOnConfirm: true,
            preConfirm: async (amount) => {
                try {
                    // Perform fetch request with the entered amount
                    const response = await fetch('{% url "wallet" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: JSON.stringify({
                            amount: parseFloat(amount) // Convert amount to float
                        })
                    });
                    if (!response.ok) {
                        return Swal.showValidationMessage(`
                        ${JSON.stringify(await response.json())}
                    `);
                    }

                    const data = await response.json();

                    // Extract payment information from the response
                    const paymentOrderId = data.payment_order_id;
                    const paymentAmount = data.amount;
                    const RAZOR_PAY_KEY_ID = data.RAZOR_PAY_KEY_ID

                    console.log('Payment information:', paymentOrderId, paymentAmount, RAZOR_PAY_KEY_ID);

                    // Use the extracted payment information as needed in your frontend code

                    return {
                        payment_order_id: paymentOrderId,
                        amount: paymentAmount,
                        RAZOR_PAY_KEY_ID: RAZOR_PAY_KEY_ID

                    };

                } catch (error) {
                    console.log('Request failed:', error);
                    throw new Error(error);
                }
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            const paymentOrderId = result.value.payment_order_id;
            const paymentAmount = result.value.amount;
            const razorpayKeyId = result.value.RAZOR_PAY_KEY_ID;
            const userId = '{{user.id}}'
            console.log(userId);
            console.log(paymentOrderId, paymentAmount, razorpayKeyId, 'got it');
            var options = {
                "key": razorpayKeyId,
                "amount": paymentAmount,
                "currency": "INR",
                "name": "PixelDot",
                "description": "Test Transaction",
                "order_id": paymentOrderId,
                "callback_url": `https://mirsa.online/paymenthandler2/?amount=${paymentAmount}&user_id=${userId}`,
                "prefill": {
                    "name": "{{ request.user.get_username }}",
                    "email": "{{ request.user.email }}",
                    "contact": "{{ request.user.phone_number }}"
                },
                "theme": {
                    "color": "#b19361"
                }
            };

            var rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response) {
                alert(response.error.code);
                // alert(response.error.description);
                // alert(response.error.source);
                // alert(response.error.step);
                // alert(response.error.reason);
                // alert(response.error.metadata.order_id);
                // alert(response.error.metadata.payment_id);
            });
            rzp1.open();
            e.preventDefault();


        });
    });

</script>

<script>
function cancelOrderConfirmation(orderId) {
    Swal.fire({
        title: 'Are you sure?',
        text: 'Do you want to cancel the order?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, cancel it!',
        cancelButtonText: 'No',
    }).then((result) => {
        if (result.isConfirmed) {
            var data = {
                        order_id: orderId,
                        new_status: "Cancelled User"
                    };
            fetch('{% url "update_orderitem_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') // Include CSRF token
            },
            body: JSON.stringify(data), // Send selected option ID as JSON data
        })
        .then(response => response.json())
        .then ( data =>{
            console.log('POST request successful');
            window.location.reload()              
        })
        .catch(error => {
            // Handle error here if needed
            console.error('Error:', error);
        });
    
        }
    });
}

function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Extract CSRF token
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
   

{% endblock content %}



